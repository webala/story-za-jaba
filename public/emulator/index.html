<!--
  âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT âš ï¸
  
  This file was automatically generated by 'beemi test' command
  Generated: 2025-08-23T12:46:57.231Z
  Source: Beemi Server SDK Manifest
  
  Manual changes to this file will be lost when running 'beemi test'
  To customize emulator behavior, modify your project's manifest.json instead
-->

<!--
  âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT âš ï¸
  
  This file was automatically generated by 'beemi test' command
  Generated: 2025-08-22T18:49:12.933Z
  Source: Beemi Server SDK Manifest
  
  Manual changes to this file will be lost when running 'beemi test'
  To customize emulator behavior, modify your project's manifest.json instead
-->

<!--
  âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT âš ï¸
  
  This file was automatically generated by 'beemi test' command
  Generated: 2025-08-21T11:12:17.224Z
  Source: Beemi Server SDK Manifest
  
  Manual changes to this file will be lost when running 'beemi test'
  To customize emulator behavior, modify your project's manifest.json instead
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test1 - iPhone Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.1) 1px, transparent 0);
            background-size: 20px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Transparent background when embedded */
        body.embedded {
            background: transparent;
        }

        /* Page Header */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 16px 24px;
        }

        .page-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #E038C9 0%, #F6CB2D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
            letter-spacing: -0.025em;
        }

        .page-header .icon-phone {
            width: 28px;
            height: 28px;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
        }

        .page-header .icon-phone svg {
            fill: #F34991;
        }

        /* Hide header when embedded */
        body.embedded .page-header {
            display: none;
        }

        .preview-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            max-height: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            padding-top: 70px; /* Account for fixed header */
        }

        /* Remove header padding when embedded */
        body.embedded .preview-container {
            padding-top: 0;
        }

        .phone-section {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            margin-left: -90px; /* Overlap into control panel */
            transition: all 0.3s ease;
        }

        .control-panel-frame {
            position: relative;
            width: 300px; /* Reduced width for embedded view */
            height: 100%;
            max-height: 740px;
            margin-left: -30px;
            margin-right: -60px;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .control-panel {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 12px;
            padding-left: 54px; /* Refined padding for phone overlap area */
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            position: relative;
        }

        .control-panel h2 {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin: 0;
            margin-bottom: 10px;
            text-align: center;
        }

        .collapse-toggle {
            position: absolute;
            top: 20px;
            right: -28px;
            width: 30px;
            height: 60px;
            background: linear-gradient(135deg, #E038C9 0%, #F6CB2D 100%);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 0 5px 5px 0;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #ffffff;
            transition: all 0.3s ease;
            z-index: 0;
        }

        .collapse-toggle:hover {
            background: linear-gradient(135deg, #E038C9 0%, #F6CB2D 100%);
            transform: translateX(-2px);
            box-shadow: -4px 0 12px rgba(224, 56, 201, 0.3);
        }

        .control-panel-frame.collapsed {
            transform: translateX(-120px);
        }

        .phone-section.collapsed {
            transform: translateX(150px);
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

                 .module-group {
             border: 1px solid rgba(0, 0, 0, 0.1);
             border-radius: 8px;
             padding: 10px;
             margin-bottom: 12px;
             background: rgba(255, 255, 255, 0.5);
         }

                 .control-section h3 {
             font-size: 14px;
             font-weight: 500;
             color: #333;
             text-transform: none;
             letter-spacing: 0;
             margin: 0 0 8px 0;
         }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .username-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: white;
            transition: all 0.2s ease;
        }

        .user-avatar:hover {
            border-color: #007AFF;
            transform: scale(1.05);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-text {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .dropdown-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .user-dropdown {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            padding: 8px 12px;
            cursor: pointer;
        }

        .user-dropdown option {
            padding: 8px 12px;
            font-size: 14px;
        }





        .control-button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #34C759;
            color: white;
        }

        .btn-secondary:hover {
            background: #28A745;
        }

        .gift-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .gift-button {
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }

        .gift-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .gift-rose {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        }

        .gift-heart {
            background: linear-gradient(135deg, #FF3B7D, #FF6B9D);
        }

        .gift-diamond {
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
        }

        .gift-rocket {
            background: linear-gradient(135deg, #3B82F6, #60A5FA);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: #34C759;
            font-weight: 500;
        }

        .status-dot-live {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34C759;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .virtual-phone {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        .iphone-frame {
            position: relative;
            width: 411px;
            height: 865px;
            background: linear-gradient(145deg, #696969, #1c1c1e);
            border-radius: 47px;
            padding: 10px;
            box-shadow: 
                0 0 0 2px #000000,
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .iphone-frame::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: #1c1c1e;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .iphone-frame::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #1a1a1a 30%, #000000 70%);
            border-radius: 50%;
            border: 1px solid #333;
        }

        .iphone-screen {
            width: 390px;
            height: 844px;
            background: #fff;
            border-radius: 39px;
            overflow: hidden;
            position: relative;
        }

        .notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 164px;
            height: 32px;
            background: #626262;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 54px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            font-size: 17px;
            font-weight: 600;
            z-index: 5;
        }

        .time {
            color: #000;
        }

        .battery-wifi {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #000;
        }

        .app-header {
            position: absolute;
            top: 54px;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .back-button {
            color: #007AFF;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .app-title {
            font-size: 17px;
            font-weight: 600;
            color: #000;
        }

        .test-badge {
            background: #34C759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .content-area {
            position: absolute;
            top: 114px;
            left: 0;
            right: 0;
            bottom: 34px;
            display: flex;
            flex-direction: column;
        }

        .top-section {
            height: 40%;
            display: flex;
        }

        .camera-view {
            width: 50%;
            background: linear-gradient(45deg, #1a1a1a, #2d2d2d);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .camera-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .camera-icon {
            width: 24px;
            height: 24px;
            color: white;
        }

        .camera-status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .live-chat {
            width: 50%;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            background: white;
            padding: 8px 12px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .chat-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-username {
            font-weight: 600;
            color: #007AFF;
            font-size: 12px;
        }

        .chat-text {
            color: #333;
            font-size: 14px;
            margin-top: 2px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-area {
            height: 60%;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .webview-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: white;
            overflow: hidden;
        }

        .webview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .home-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: #000;
            border-radius: 3px;
        }




        
        /* Compact styles for streams module */
        #streams-module {
            padding: 12px;
            margin-bottom: 6px;
        }

        #streams-module .control-section {
            gap: 6px;
            margin-bottom: 10px;
        }

        #streams-module .control-section h3 {
            font-size: 12px;
            margin-bottom: 4px;
        }

        #streams-module .input-group {
            gap: 4px;
        }

        #streams-module .control-input {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
        }

        #streams-module .control-button {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            margin: 1px 0;
        }

        #streams-module .gift-grid {
            gap: 4px;
        }

        #streams-module .gift-button {
            padding: 4px 8px;
            font-size: 11px;
            min-height: 28px;
            border-radius: 6px;
        }

        #streams-module .username-container {
            gap: 6px;
        }

        #streams-module .user-avatar {
            width: 24px;
            height: 24px;
        }

        /* Message input row with inline send button */
        #streams-module .message-input-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        #streams-module .message-input-row .control-input {
            flex: 1;
        }

        #streams-module .send-button {
            width: 32px;
            height: 32px;
            padding: 0;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        #streams-module .send-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        #streams-module .send-button:active {
            transform: translateY(0);
        }

        /* Interaction buttons side by side */
        #streams-module .interaction-buttons {
            display: flex;
            gap: 6px;
        }

        #streams-module .interaction-buttons .control-button {
            flex: 1;
        }

                 /* Debug Tools - Smaller buttons */
         #debug-module .control-button {
             padding: 6px 12px;
             font-size: 12px;
             font-weight: 500;
             border-radius: 8px;
             margin-bottom: 3px;
         }

         #debug-module .control-button:hover {
             transform: translateY(-0.5px);
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
         }

         /* Collapsible Module Groups */
         .module-group > h3 {
             cursor: pointer;
             position: relative;
             text-transform: uppercase;
             font-weight: 600;
             color: #666;
             font-size: 12px;
         }

         .module-group > h3::after {
             content: 'â–¼';
             position: absolute;
             right: 0;
             font-size: 12px;
             transition: transform 0.2s ease;
         }

         .module-group.collapsed > h3::after {
             transform: rotate(-90deg);
         }

         .module-content {
             transition: max-height 0.3s ease, opacity 0.3s ease;
             overflow: hidden;
         }

         .module-group.collapsed .module-content {
             max-height: 0;
             opacity: 0;
         }

         .module-group:not(.collapsed) .module-content {
             max-height: 1000px;
             opacity: 1;
             padding-top: 10px;
         }
    </style>
</head>
<body>
    <div class="preview-container">
        <div class="phone-section">
            <div class="iphone-frame">
                <div class="iphone-screen">
                    <div class="notch"></div>
                    
                    <div class="status-bar">
                        <div class="time">4:19</div>
                        <div class="battery-wifi">
                            <span>ğŸ“¶</span>
                            <span>ğŸ”‹</span>
                        </div>
                    </div>

                    <div class="app-header">
                        <div class="back-button">â† Back</div>
                        <div class="app-title">test1</div>
                        <div class="test-badge">Test</div>
                    </div>

                    <div class="content-area">
                        <div class="top-section">
                            <div class="camera-view">
                                <div class="camera-placeholder">
                                    <svg class="camera-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 15.5c1.93 0 3.5-1.57 3.5-3.5S13.93 8.5 12 8.5 8.5 10.07 8.5 12s1.57 3.5 3.5 3.5z"/>
                                        <path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
                                    </svg>
                                </div>
                                <div class="camera-status">
                                    <div class="status-dot"></div>
                                    Camera Off
                                </div>
                            </div>

                            <div class="live-chat">
                                <div class="chat-header">Live Chat</div>
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Messages will be added through control panel interactions -->
                                </div>
                            </div>
                        </div>

                        <div class="project-area">
                            <div class="webview-container">
                                <div class="virtual-phone">
                                    <iframe class="webview-iframe" src="/" title="test1"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="home-indicator"></div>
                </div>
            </div>
        </div>

        <div class="control-panel-frame">
            <button class="collapse-toggle" onclick="toggleControlPanel()" title="Collapse Panel">
                â€¹
            </button>
            <div class="control-panel">
                <h2>Emulator Tools</h2>

            <!-- Streams Module Controls -->
            <div class="module-group" id="streams-module" style="display: none;">
                <h3 onclick="toggleModule('streams-module')">ğŸ“º Streams</h3>
                <div class="module-content">
                    <div class="control-section">
                        <h3>ğŸ‘¤ Viewer</h3>
                    <div class="input-group">
                        <div class="username-container">
                            <img id="userAvatar" class="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=viewer1" alt="User Avatar">
                            <input type="text" class="control-input" id="usernameInput" placeholder="Username" value="viewer1">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>ğŸ’¬ Chat</h3>
                    <div class="input-group">
                        <div class="message-input-row">
                            <input type="text" class="control-input" id="messageInput" placeholder="Enter chat message...">
                            <button class="send-button" onclick="sendChatMessage()">
                                â¤
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>â¤ï¸ Interactions</h3>
                    <div class="interaction-buttons">
                        <button class="control-button btn-secondary" onclick="sendLike()">
                            â¤ï¸ Like
                        </button>
                        <button class="control-button btn-secondary" onclick="sendFollow()">
                            ğŸ‘¥ Follow
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>ğŸ Gifts</h3>
                    <div class="gift-grid">
                        <button class="gift-button gift-rose" onclick="sendGift('rose')">
                            ğŸŒ¹ Rose
                        </button>
                        <button class="gift-button gift-heart" onclick="sendGift('heart')">
                            ğŸ’– Heart
                        </button>
                        <button class="gift-button gift-diamond" onclick="sendGift('diamond')">
                            ğŸ’ Diamond
                        </button>
                        <button class="gift-button gift-rocket" onclick="sendGift('rocket')">
                            ğŸš€ Rocket
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <!-- User Module Controls -->
            <div class="module-group" id="user-module" style="display: none;">
                <h3 onclick="toggleModule('user-module')">ğŸ‘¤ User Settings</h3>
                <div class="module-content">
                    <div class="control-section">
                    <div class="input-group">
                        <select id="userSelector" class="control-input user-dropdown" onchange="changeSelectedUser()">
                            <option value="">âŒ No user</option>
                            <option value="user0">ğŸ‘¤ user0 (devgamer)</option>
                            <option value="user1">ğŸ‘¤ user1 (streamqueen)</option>
                            <option value="user2">ğŸ‘¤ user2 (gamerpro)</option>
                            <option value="user3">ğŸ‘¤ user3 (chatmaster)</option>
                            <option value="user4">ğŸ‘¤ user4 (viewer123)</option>
                            <option value="user5">ğŸ‘¤ user5 (livestream)</option>
                            <option value="user6">ğŸ‘¤ user6 (tiktokfan)</option>
                            <option value="user7">ğŸ‘¤ user7 (youtuber)</option>
                            <option value="user8">ğŸ‘¤ user8 (twitchgamer)</option>
                            <option value="user9">ğŸ‘¤ user9 (beemifan)</option>
                        </select>
                    </div>
                </div>
                </div>
            </div>

            <!-- App-Bridge Module Controls -->
            <div class="module-group" id="app-bridge-module" style="display: none;">
                <h3 onclick="toggleModule('app-bridge-module')">ğŸŒ‰ Bridge Settings</h3>
                <div class="module-content">
                    <div class="control-section">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="bridgeAlertsCheckbox" checked onchange="toggleBridgeAlerts()">
                            <span class="checkbox-text">ğŸ”” Show Bridge Alerts</span>
                        </label>
                    </div>

                </div>
                </div>
            </div>

            <!-- Debug Module Controls -->
            <div class="module-group collapsed" id="debug-module">
                <h3 onclick="toggleModule('debug-module')">ğŸ”§ Debug Tools</h3>
                <div class="module-content">
                    <div class="control-section">
                    
                    <!-- Multiplayer Debug -->
                    <div class="input-group">
                        <h4 style="font-size: 12px; color: #666; margin: 8px 0 4px 0;">ğŸ® Multiplayer Debug</h4>
                        <button onclick="debugMultiplayerState()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ“Š Show MP State
                        </button>
                        <button onclick="debugCRDTState()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ“ Show CRDT State
                        </button>
                        <button onclick="debugRoomState()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ  Show Room State
                        </button>
                    </div>

                    <!-- Client Debug -->
                    <div class="input-group">
                        <h4 style="font-size: 12px; color: #666; margin: 8px 0 4px 0;">ğŸ‘¤ Client Debug</h4>
                        <button onclick="debugClientInfo()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ” Client Info
                        </button>
                        <button onclick="debugSDKStatus()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            âš™ï¸ SDK Status
                        </button>
                        <button onclick="testMultiClientRelay()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸŒ‰ Test Relay
                        </button>
                    </div>

                    <!-- Game Debug -->
                    <div class="input-group">
                        <h4 style="font-size: 12px; color: #666; margin: 8px 0 4px 0;">ğŸ¯ Game Debug</h4>
                        <button onclick="debugGameState()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ® Game State
                        </button>
                        <button onclick="clearGameConsole()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ—‘ï¸ Clear Console
                        </button>
                    </div>

                    <!-- Manual Room Test -->
                    <div class="input-group">
                        <h4 style="font-size: 12px; color: #666; margin: 8px 0 4px 0;">ğŸ  Room Test</h4>
                        <button onclick="testHostRoom()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ  Test Host
                        </button>
                        <button onclick="testJoinRoom()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸšª Test Join
                        </button>
                        <button onclick="checkInjectionStatus()" class="control-button btn-secondary" style="margin-bottom: 4px;">
                            ğŸ” Check Injection
                        </button>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // Module collapse/expand functionality
        function toggleModule(moduleId) {
            const module = document.getElementById(moduleId);
            if (module) {
                module.classList.toggle('collapsed');
            }
        }

        // Control panel collapse/expand functionality
        function toggleControlPanel() {
            const controlPanelFrame = document.querySelector('.control-panel-frame');
            const phoneSection = document.querySelector('.phone-section');
            const toggleButton = document.querySelector('.collapse-toggle');
            
            controlPanelFrame.classList.toggle('collapsed');
            phoneSection.classList.toggle('collapsed');
            
            // Update button text and title based on state
            if (controlPanelFrame.classList.contains('collapsed')) {
                toggleButton.innerHTML = 'â€º';
                toggleButton.title = 'Expand Panel';
            } else {
                toggleButton.innerHTML = 'â€¹';
                toggleButton.title = 'Collapse Panel';
            }
        }

        // Update time every minute
        function updateTime() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            document.querySelector('.time').textContent = timeString;
        }

        updateTime();
        setInterval(updateTime, 60000);

        // Smart Preview: Match React Native WebView scalesPageToFit behavior
        const iframe = document.querySelector('.webview-iframe');
        
        function applyScaling(iframe) {
            const scale = 0.4; // Match React Native auto-scaling
            
            iframe.style.transform = `scale(${scale})`;
            iframe.style.transformOrigin = '0 0';
            
            // Adjust iframe size to compensate for scaling
            const scaleCompensation = 1 / scale;
            iframe.style.width = `${scaleCompensation * 100}%`;
            iframe.style.height = `${scaleCompensation * 100}%`;
            
            console.log('ğŸ“± Applied scaling (matching React Native behavior for non-responsive sites)');
        }
        
        function removeScaling(iframe) {
            iframe.style.transform = 'none';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            
            console.log('ğŸ“± No scaling applied (matching React Native behavior for responsive sites)');
        }
        
        function setupPreviewMatching() {
            if (!iframe) return;
            
            console.log('ğŸ” Analyzing project for React Native WebView compatibility...');
            
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        // Check for viewport meta tag
                        const viewportMeta = iframeDoc.querySelector('meta[name="viewport"]');
                        
                        if (!viewportMeta) {
                            console.log('âŒ No viewport meta tag found');
                            console.log('ğŸ¯ React Native will auto-scale this project');
                            applyScaling(iframe);
                        } else {
                            console.log('âœ… Viewport meta tag found:', viewportMeta.content);
                            console.log('ğŸ¯ React Native will render this project naturally');
                            removeScaling(iframe);
                        }
                        
                        // Log project analysis
                        const title = iframeDoc.title || 'Untitled Project';
                        console.log(`ğŸ“Š Project Analysis: "${title}"`);
                        console.log('   - Viewport Meta Tag:', viewportMeta ? 'âœ… Present' : 'âŒ Missing');
                        console.log('   - Preview Scaling:', viewportMeta ? 'âŒ Disabled' : 'âœ… Enabled');
                        console.log('   - React Native Scaling:', viewportMeta ? 'âŒ Disabled' : 'âœ… Enabled');
                        console.log('   - Preview Accuracy: ğŸ¯ Matches React Native WebView');
                        
                    } else {
                        throw new Error('Cannot access iframe document');
                    }
                } catch (error) {
                    console.log('âš ï¸ Cannot access iframe content (CORS restriction)');
                    console.log('ğŸ¯ Applying scaling as fallback (safer assumption for platform)');
                    applyScaling(iframe);
                }
            }, 100);
        }
        
        // Setup preview matching when iframe loads
        iframe.onload = function() {
            setupPreviewMatching();
        };
        
        // Setup immediately if iframe is already loaded
        if (iframe && iframe.complete) {
            setupPreviewMatching();
        }

        // Initialize React Native WebView communication
        setupIframeDebugging();
        
        // Initialize module-based controls
        initializeModuleControls();
        
        // User data definitions for dropdown selection (make globally accessible for bridge emulator)
        const USER_DATA = {
            user0: {
                id: 'user0',
                username: 'devgamer',
                display_name: 'Dev Gamer',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=devgamer'
            },
            user1: {
                id: 'user1',
                username: 'streamqueen',
                display_name: 'Stream Queen',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=streamqueen'
            },
            user2: {
                id: 'user2',
                username: 'gamerpro',
                display_name: 'Gamer Pro',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=gamerpro'
            },
            user3: {
                id: 'user3',
                username: 'chatmaster',
                display_name: 'Chat Master',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=chatmaster'
            },
            user4: {
                id: 'user4',
                username: 'viewer123',
                display_name: 'Viewer 123',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=viewer123'
            },
            user5: {
                id: 'user5',
                username: 'livestream',
                display_name: 'Live Stream',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=livestream'
            },
            user6: {
                id: 'user6',
                username: 'tiktokfan',
                display_name: 'TikTok Fan',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=tiktokfan'
            },
            user7: {
                id: 'user7',
                username: 'youtuber',
                display_name: 'YouTuber',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=youtuber'
            },
            user8: {
                id: 'user8',
                username: 'twitchgamer',
                display_name: 'Twitch Gamer',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=twitchgamer'
            },
            user9: {
                id: 'user9',
                username: 'beemifan',
                display_name: 'Beemi Fan',
                image_url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=beemifan'
            }
        };

        // Function to generate avatar URL from username (global scope)
        function generateAvatarUrl(username) {
            const cleanUsername = username.trim() || 'Anonymous';
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(cleanUsername)}`;
        }

        // Initialize user selection IMMEDIATELY (before bridge emulator loads)
        const savedUserId = localStorage.getItem('beemi-selected-user-id');
        console.log('ğŸ” [Debug] localStorage value:', savedUserId);
        console.log('ğŸ” [Debug] savedUserId !== null:', savedUserId !== null);
        console.log('ğŸ” [Debug] USER_DATA[savedUserId] exists:', savedUserId ? !!USER_DATA[savedUserId] : 'N/A');
        
        if (savedUserId !== null && (savedUserId === '' || USER_DATA[savedUserId])) {
            window.beemiSelectedUserId = savedUserId;
            window.beemiUserInjectionEnabled = savedUserId !== '';
            console.log('ğŸ‘¤ Pre-initialized user selection:', savedUserId);
            console.log('ğŸ” [Debug] Set window.beemiSelectedUserId to:', window.beemiSelectedUserId);
        } else {
            // Default to user0
            window.beemiSelectedUserId = 'user0';
            window.beemiUserInjectionEnabled = true;
            console.log('ğŸ‘¤ Pre-initialized user selection to default: user0');
            console.log('ğŸ” [Debug] Defaulted because savedUserId was:', savedUserId);
        }

        // Handle Enter key in message input
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Setup username avatar functionality
            const usernameInput = document.getElementById('usernameInput');
            const userAvatar = document.getElementById('userAvatar');
            
            // Function to update avatar
            function updateAvatar() {
                const username = usernameInput.value;
                const avatarUrl = generateAvatarUrl(username);
                userAvatar.src = avatarUrl;
                console.log(`ğŸ­ Avatar updated for username: "${username}"`);
            }
            
            // Add event listener for username changes
            if (usernameInput && userAvatar) {
                usernameInput.addEventListener('input', updateAvatar);
                usernameInput.addEventListener('change', updateAvatar);
                
                // Update avatar on initial load
                updateAvatar();
            }
            
            // Sync dropdown UI with pre-initialized user selection
            const userSelector = document.getElementById('userSelector');
            const currentUserId = window.beemiSelectedUserId;
            
            console.log('ğŸ” [Debug] UI Sync - currentUserId from window:', currentUserId);
            console.log('ğŸ” [Debug] UI Sync - userSelector found:', !!userSelector);
            console.log('ğŸ” [Debug] UI Sync - userSelector.value before:', userSelector ? userSelector.value : 'N/A');
            
            // Set dropdown to match pre-initialized value
            if (userSelector) {
                userSelector.value = currentUserId;
                console.log('ğŸ” [Debug] UI Sync - userSelector.value after:', userSelector.value);
            }
            
            console.log('ğŸ‘¤ User selection UI synced with pre-initialized value:', currentUserId);
            
            // Restore bridge alerts checkbox state
            const bridgeAlertsCheckbox = document.getElementById('bridgeAlertsCheckbox');
            const savedBridgeState = localStorage.getItem('beemi-bridge-alerts-enabled');
            
            if (savedBridgeState !== null) {
                const isEnabled = savedBridgeState === 'true';
                bridgeAlertsCheckbox.checked = isEnabled;
                
                // Communicate preference to iframe
                window.beemiShowBridgeAlerts = isEnabled;
                console.log('ğŸŒ‰ Bridge alerts preference restored:', isEnabled);
            } else {
                // Default to enabled
                window.beemiShowBridgeAlerts = true;
                console.log('ğŸŒ‰ Bridge alerts preference set to default: enabled');
            }
            
            // Additional setup after DOM is ready
            setTimeout(() => {
                console.log('ğŸš€ Control panel ready - using React Native WebView communication...');
                setupIframeDebugging();
            }, 500);
        });

        // Enhanced SDK Communication
        function sendToWebView(messageData) {
            const iframe = document.querySelector('.webview-iframe');
            if (!iframe || !iframe.contentWindow) {
                console.log('âŒ Iframe not accessible');
                return false;
            }

            try {
                // Access the injected Beemi SDK directly
                const contentWindow = iframe.contentWindow;
                if (contentWindow.beemi && contentWindow.beemi.core && contentWindow.beemi.core.emit) {
                    
                    // For gift events, emit directly as stream-gift (not wrapped in room-event)
                    if (messageData.type === 'stream-gift') {
                        contentWindow.beemi.core.emit('stream-gift', messageData);
                        
                        // Also try triggering streams callbacks directly if available
                        if (contentWindow.beemi.streams && contentWindow.beemi.streams._giftCallbacks) {
                            contentWindow.beemi.streams._giftCallbacks.forEach(callback => {
                                try {
                                    callback(messageData.data);
                                } catch (error) {
                                    console.error('âŒ Error in game gift callback:', error);
                                }
                            });
                        }
                    } else {
                        // Send via Beemi SDK (preferred method) - use room-event with payload wrapper for other events
                        contentWindow.beemi.core.emit('room-event', { payload: messageData });
                    }
                    
                    return true;
                } else {
                    // Fallback: PostMessage for backwards compatibility
                    const messageString = JSON.stringify(messageData);
                    contentWindow.postMessage(messageString, '*');
                    return true;
                }
                
            } catch (error) {
                console.log('âŒ Failed to send message:', error);
                return false;
            }
        }

        // Control Panel Functions - Using Beemi SDK Format
        function sendChatMessage() {
            console.log('ğŸ”¥ sendChatMessage function called');
            const usernameInput = document.getElementById('usernameInput');
            const messageInput = document.getElementById('messageInput');
            const username = usernameInput.value.trim() || 'Anonymous';
            const message = messageInput.value.trim();
            
            if (!message) {
                messageInput.focus();
                return;
            }
            
            console.log('ğŸ’¬ Sending chat message via Beemi SDK:', { username, message });
            
            // Add to visual chat display
            const chatContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            // Generate avatar URL for the chat message
            const avatarUrl = generateAvatarUrl(username);
            
            messageElement.innerHTML = `
                <img src="${avatarUrl}" alt="${username}" class="chat-avatar">
                <div class="chat-content">
                    <div class="chat-username">${username}</div>
                    <div class="chat-text">${message}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
            
            // Clear message input
            messageInput.value = '';
            messageInput.focus();
            
            // Send to game using beemiDev.simulateChat (from top context)
            if (window.beemiDev) {
                // Use the emulator's simulateChat function which includes imageUrl
                window.beemiDev.streams.simulateChat(username, message);
                console.log('âœ… Chat message sent via window.beemiDev.streams.simulateChat');
            } else {
                // Retry after a short delay if beemiDev isn't ready yet
                console.log('â³ beemiDev not ready, retrying in 100ms...');
                setTimeout(() => {
                    if (window.beemiDev) {
                        window.beemiDev.streams.simulateChat(username, message);
                        console.log('âœ… Chat message sent via window.beemiDev.streams.simulateChat (delayed)');
                    } else {
                        console.log('âŒ beemiDev still not available after retry');
                    }
                }, 100);
            }
        }

        function sendLike() {
            console.log('â¤ï¸ Note: React Native doesn\'t send likes to WebView - they stay in RN UI');
            
            // Add to visual chat display only
            const chatContainer = document.getElementById('chatMessages');
            const likeElement = document.createElement('div');
            likeElement.className = 'chat-message';
            likeElement.innerHTML = `
                <div class="chat-username">â¤ï¸</div>
                <div class="chat-text">Like received! (RN UI only)</div>
            `;
            
            chatContainer.appendChild(likeElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
        }

        function sendFollow() {
            console.log('ğŸ‘¥ Note: React Native doesn\'t send follows to WebView - they stay in RN UI');
            
            // Add to visual chat display only
            const chatContainer = document.getElementById('chatMessages');
            const followElement = document.createElement('div');
            followElement.className = 'chat-message';
            followElement.innerHTML = `
                <div class="chat-username">ğŸ‘¥</div>
                <div class="chat-text">New follower! (RN UI only)</div>
            `;
            
            chatContainer.appendChild(followElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove old messages to prevent overflow
            if (chatContainer.children.length > 12) {
                chatContainer.removeChild(chatContainer.firstChild);
            }
        }

        function sendGift(giftType) {
            const giftEmojis = {
                rose: 'ğŸŒ¹',
                heart: 'ğŸ’–',
                diamond: 'ğŸ’',
                rocket: 'ğŸš€'
            };
            
            const giftNames = {
                rose: 'Rose',
                heart: 'Heart',
                diamond: 'Diamond',
                rocket: 'Rocket'
            };
            
            const giftValues = {
                rose: 5,
                heart: 10,
                diamond: 50,
                rocket: 100
            };
            
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim() || 'Anonymous';
            const giftCount = Math.floor(Math.random() * 5) + 1; // Random 1-5 gifts
            const unitValue = giftValues[giftType];
            const totalValue = unitValue * giftCount;
            
            console.log(`ğŸ Sending ${giftNames[giftType]} gift: ${username} x${giftCount} (${totalValue} coins)`);
            
            // Create gift data matching React Native format
            const giftData = {
                type: 'stream-gift',
                data: {
                    user: {
                        id: `tiktok_${username}`,
                        username: username,
                        displayName: username,
                        platform: 'tiktok'
                    },
                    gift: {
                        name: giftNames[giftType],
                        count: giftCount,
                        value: totalValue,        // Total diamond value (fallback)
                        coin_value: totalValue,   // Primary value expected by game
                        unitValue: unitValue      // Per-gift diamond value (React Native compat)
                    },
                    messageId: `gift_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    platform: 'tiktok',
                    timestamp: Date.now()
                }
            };
            
            // Send to WebView/Game via Beemi SDK
            const success = sendToWebView(giftData);
            
            if (success) {
                // Add to visual chat display for emulator UI feedback
                const chatContainer = document.getElementById('chatMessages');
                const giftElement = document.createElement('div');
                giftElement.className = 'chat-message';
                giftElement.innerHTML = `
                    <div class="chat-username">${giftEmojis[giftType]} ${username}</div>
                    <div class="chat-text">sent ${giftCount}x ${giftNames[giftType]} (ğŸ’ ${totalValue})</div>
                `;
                
                chatContainer.appendChild(giftElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Remove old messages to prevent overflow
                if (chatContainer.children.length > 12) {
                    chatContainer.removeChild(chatContainer.firstChild);
                }
            } else {
                console.error('âŒ Failed to send gift to WebView');
            }
        }

        // Handle user selection change from dropdown
        function changeSelectedUser() {
            const userSelector = document.getElementById('userSelector');
            const userStatus = document.getElementById('userStatus');
            const iframe = document.querySelector('.webview-iframe');
            const selectedUserId = userSelector.value;
            
            // Update global state
            window.beemiSelectedUserId = selectedUserId;
            window.beemiUserInjectionEnabled = selectedUserId !== '';
            
            if (selectedUserId && USER_DATA[selectedUserId]) {
                // Inject selected user data via events
                const userData = USER_DATA[selectedUserId];
                console.log(`ğŸ‘¤ User selected: ${selectedUserId} (${userData.username}) - injecting via events`);
                userStatus.textContent = `âœ… User injected: ${userData.username} (${selectedUserId})`;
                userStatus.classList.remove('user-disabled');
                
                // Inject user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                    iframe.contentWindow.beemi.core.emit('user-data-received', userData);
                    console.log('ğŸ‘¤ User data injected via events:', userData);
                }
            } else {
                // No user selected - clear user data via events
                console.log('ğŸ‘¤ No user selected - clearing user via events');
                userStatus.textContent = 'âŒ No user object';
                userStatus.classList.add('user-disabled');
                
                // Clear user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                    iframe.contentWindow.beemi.core.emit('user-signed-out');
                    console.log('ğŸ‘¤ User cleared via events');
                }
            }
            
            // Store preference
            localStorage.setItem('beemi-selected-user-id', selectedUserId);
            
            // No iframe reload needed - events handle real-time updates!
            console.log('âœ¨ User selection changed without iframe reload - using real-time events');
        }

        // Toggle bridge alerts
        function toggleBridgeAlerts() {
            const checkbox = document.getElementById('bridgeAlertsCheckbox');
            
            // Update global state
            window.beemiShowBridgeAlerts = checkbox.checked;
            
            if (checkbox.checked) {
                console.log('ğŸŒ‰ Bridge alerts enabled - will show alerts for app bridge calls');
            } else {
                console.log('ğŸŒ‰ Bridge alerts disabled - app bridge calls will be silent');
            }
            
            // Store preference
            localStorage.setItem('beemi-bridge-alerts-enabled', checkbox.checked);
        }

        // Handle user selection change from dropdown
        function changeSelectedUser() {
            const userSelector = document.getElementById('userSelector');
            const iframe = document.querySelector('.webview-iframe');
            const selectedUserId = userSelector.value;
            
            console.log('ğŸ”„ User selection changed to:', selectedUserId);
            
            // Update global state
            window.beemiSelectedUserId = selectedUserId;
            window.beemiUserInjectionEnabled = selectedUserId !== '';
            
            if (selectedUserId && USER_DATA[selectedUserId]) {
                // Inject selected user data via events
                const userData = USER_DATA[selectedUserId];
                console.log(`ğŸ‘¤ User selected: ${selectedUserId} (${userData.username}) - injecting via events`);
                
                // Inject user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi && iframe.contentWindow.beemi.core) {
                    iframe.contentWindow.beemi.core.emit('user-data-received', userData);
                    console.log('âœ… User data injected via events:', userData);
                }
            } else {
                // No user selected - clear user data via events
                console.log('ğŸ‘¤ No user selected - clearing user via events');
                
                // Clear user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi && iframe.contentWindow.beemi.core) {
                    iframe.contentWindow.beemi.core.emit('user-signed-out');
                    console.log('âœ… User signed out via events');
                }
            }
            
            // Store preference in localStorage
            localStorage.setItem('beemi-selected-user-id', selectedUserId);
            console.log('ğŸ’¾ Saved to localStorage:', selectedUserId);
            
            // No iframe reload needed - events handle real-time updates!
            console.log('âœ¨ User selection changed without iframe reload - using real-time events');
        }

        // Handle user selection change from dropdown
        function changeSelectedUser() {
            const userSelector = document.getElementById('userSelector');
            const iframe = document.querySelector('.webview-iframe');
            const selectedUserId = userSelector.value;
            
            console.log('ğŸ‘¤ User selection changed to:', selectedUserId);
            
            // Update global state
            window.beemiSelectedUserId = selectedUserId;
            window.beemiUserInjectionEnabled = selectedUserId !== '';
            
            if (selectedUserId && USER_DATA[selectedUserId]) {
                // Inject selected user data via events
                const userData = USER_DATA[selectedUserId];
                console.log(`ğŸ‘¤ User selected: ${selectedUserId} (${userData.username}) - injecting via events`);
                
                // Inject user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi && iframe.contentWindow.beemi.core) {
                    iframe.contentWindow.beemi.core.emit('user-data-received', userData);
                    console.log('âœ… User data injected via events:', userData);
                }
            } else {
                // No user selected - clear user data via events
                console.log('ğŸ‘¤ No user selected - clearing user via events');
                
                // Clear user data immediately via events (no reload needed)
                if (iframe && iframe.contentWindow && iframe.contentWindow.beemi && iframe.contentWindow.beemi.core) {
                    iframe.contentWindow.beemi.core.emit('user-signed-out');
                    console.log('âœ… User signed out via events');
                }
            }
            
            // Store preference in localStorage
            localStorage.setItem('beemi-selected-user-id', selectedUserId);
            console.log('ğŸ’¾ Saved user selection to localStorage:', selectedUserId);
            
            // No iframe reload needed - events handle real-time updates!
            console.log('âœ¨ User selection changed without iframe reload - using real-time events');
        }

        // Initialize module-based controls based on manifest
        async function initializeModuleControls() {
            try {
                // Load manifest to check enabled modules
                const response = await fetch('./manifest.json');
                const manifest = await response.json();
                
                console.log('ğŸ“‹ Loaded manifest for module detection:', manifest.name);
                
                const beemiConfig = manifest.beemi || {};
                
                // Show modules based on manifest configuration
                if (beemiConfig.user && beemiConfig.user.required) {
                    document.getElementById('user-module').style.display = 'block';
                    console.log('ğŸ‘¤ User module enabled');
                }
                
                if (beemiConfig['app-bridge'] && beemiConfig['app-bridge'].required) {
                    document.getElementById('app-bridge-module').style.display = 'block';
                    console.log('ğŸŒ‰ App-Bridge module enabled');
                }
                
                if (beemiConfig.streams && beemiConfig.streams.required) {
                    document.getElementById('streams-module').style.display = 'block';
                    console.log('ğŸ“º Streams module enabled');
                }
                
                // Log enabled modules for debugging
                const enabledModules = [];
                if (beemiConfig.user?.required) enabledModules.push('User');
                if (beemiConfig['app-bridge']?.required) enabledModules.push('App-Bridge');
                if (beemiConfig.streams?.required) enabledModules.push('Streams');
                if (beemiConfig['multiplayer-p2p']?.required) enabledModules.push('Multiplayer');
                
                console.log(`ğŸ“‹ Active modules: ${enabledModules.join(', ')}`);
                
            } catch (error) {
                console.error('âŒ Failed to load manifest for module detection:', error);
                // Fallback: show all modules
                document.getElementById('streams-module').style.display = 'block';
                document.getElementById('user-module').style.display = 'block';
                document.getElementById('app-bridge-module').style.display = 'block';
            }
        }
        
        // Simulate App-Bridge functionality
        function simulateAppBridgeCall() {
            console.log('ğŸ“± Simulating app bridge call...');
            
            const iframe = document.querySelector('.webview-iframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                // Simulate a native app bridge call
                const bridgeData = {
                    type: 'app-bridge-call',
                    method: 'showNativeAlert',
                    params: {
                        title: 'Emulator Test',
                        message: 'This is a simulated app bridge call from the emulator!',
                        timestamp: Date.now()
                    }
                };
                
                iframe.contentWindow.beemi.core.emit('app-bridge-event', bridgeData);
                console.log('âœ… App bridge event sent:', bridgeData);
                
                if (window.beemiShowBridgeAlerts) {
                    alert('App Bridge Call Simulated: showNativeAlert');
                }
            } else {
                console.log('âš ï¸ App bridge simulation failed - SDK not ready');
            }
        }

        // Setup iframe debugging and SDK communication
        function setupIframeDebugging() {
            const iframe = document.querySelector('.webview-iframe');
            if (!iframe) {
                console.log('âŒ Iframe not found');
                return;
            }

            iframe.onload = function() {
                console.log('âœ… Game iframe loaded with SDK injection');
                
                // Setup preview matching
                setupPreviewMatching();
                
                // Wait for SDK to initialize, then send test message
                setTimeout(() => {
                    if (window.beemiDev) {
                        window.beemiDev.streams.simulateChat('System', 'Preview connected! Module-based controls are active.');
                        console.log('ğŸ“¡ Test message sent via window.beemiDev.streams.simulateChat');
                    } else {
                        console.log('âš ï¸ beemiDev not available for test message');
                    }
                }, 2000);
            };

            iframe.onerror = function(error) {
                console.log('âŒ Iframe load error:', error);
            };
        }
        
        // Setup message listener for bridge requests (no parent access violations)
        function setupBridgeMessageListener() {
            window.addEventListener('message', (event) => {
                if (event.data.type === 'bridge-request-user-data') {
                    const userId = event.data.userId;
                    console.log('ğŸ“¨ [Emulator] Bridge requested user data for:', userId);
                    
                    // Send user data back to bridge via postMessage
                    const userData = USER_DATA[userId];
                    if (userData) {
                        event.source.postMessage({
                            type: 'emulator-user-data',
                            userId: userId,
                            userData: userData
                        }, '*');
                        console.log('âœ… [Emulator] Sent user data to bridge:', userData);
                    } else {
                        console.log('âŒ [Emulator] User data not found for:', userId);
                    }
                }
            });
        }
        
        // Initialize bridge message listener
        setupBridgeMessageListener();
        
        // Initialize iframe with proper URL parameters
        function initializeIframeWithParams() {
            const iframe = document.querySelector('.webview-iframe');
            if (iframe) {
                // Build URL parameters for the bridge
                const params = new URLSearchParams();
                params.set('userInjection', 'true');
                params.set('showBridgeAlerts', 'true');
                
                // Update iframe src with parameters
                const currentSrc = iframe.src;
                const baseUrl = currentSrc.split('?')[0];
                iframe.src = `${baseUrl}?${params.toString()}`;
                
                console.log('ğŸ”§ [Emulator] Iframe initialized with parameters:', iframe.src);
            }
        }
        
        // Initialize iframe parameters when DOM is ready
        initializeIframeWithParams();

        // =================== DEBUG FUNCTIONS ===================

        // Debug multiplayer state
        function debugMultiplayerState() {
            const iframe = document.querySelector('.webview-iframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                const mp = iframe.contentWindow.beemi.multiplayer;
                const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
                
                console.log(`ğŸ® [${clientName}] Multiplayer Debug State:`);
                console.log('  - isLeader():', mp.isLeader ? mp.isLeader() : 'N/A');
                console.log('  - Room state:', mp.room ? mp.room.getState() : 'N/A');
                console.log('  - Current room config:', mp.roomConfig || 'N/A');
                
                alert(`ğŸ® ${clientName} Multiplayer State:\n\n` +
                      `Leader: ${mp.isLeader ? mp.isLeader() : 'N/A'}\n` +
                      `Room State: ${mp.room ? JSON.stringify(mp.room.getState()) : 'N/A'}\n` +
                      `Check console for full details`);
            } else {
                alert('âŒ SDK not ready or not accessible');
            }
        }

        // Debug CRDT state
        function debugCRDTState() {
            const iframe = document.querySelector('.webview-iframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                const crdt = iframe.contentWindow.beemi.multiplayer.crdt;
                const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
                
                console.log(`ğŸ“ [${clientName}] CRDT Debug State:`);
                
                const keys = ['game-phase', 'game-players', 'player-roles', 'current-word', 'voting-results', 'voting-timer'];
                const state = {};
                
                keys.forEach(key => {
                    const value = crdt.get(key);
                    state[key] = value;
                    console.log(`  - ${key}:`, value);
                });
                
                alert(`ğŸ“ ${clientName} CRDT State:\n\n` +
                      Object.entries(state).map(([k, v]) => `${k}: ${JSON.stringify(v)}`).join('\n') +
                      `\n\nCheck console for full details`);
            } else {
                alert('âŒ SDK not ready or not accessible');
            }
        }

        // Debug room state
        function debugRoomState() {
            const iframe = document.querySelector('.webview-iframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                const room = iframe.contentWindow.beemi.multiplayer.room;
                const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
                
                console.log(`ğŸ  [${clientName}] Room Debug State:`);
                console.log('  - Room state:', room.getState());
                console.log('  - Room methods:', {
                    host: typeof room.host,
                    join: typeof room.join,
                    leave: typeof room.leave,
                    getState: typeof room.getState
                });
                
                const roomState = room.getState();
                alert(`ğŸ  ${clientName} Room State:\n\n` +
                      `State: ${JSON.stringify(roomState)}\n` +
                      `Host: ${typeof room.host}\n` +
                      `Join: ${typeof room.join}\n` +
                      `Leave: ${typeof room.leave}`);
            } else {
                alert('âŒ SDK not ready or not accessible');
            }
        }

        // Debug client info
        function debugClientInfo() {
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            const iframe = document.querySelector('.webview-iframe');
            
            console.log(`ğŸ‘¤ [${clientName}] Client Debug Info:`);
            console.log('  - Client Name:', clientName);
            console.log('  - Iframe ready:', !!iframe);
            console.log('  - ContentWindow ready:', !!iframe?.contentWindow);
            console.log('  - SDK ready:', !!iframe?.contentWindow?.beemi);
            console.log('  - Multi-client relay active:', !!iframe?.contentWindow?.multiClientEventCallbacks);
            console.log('  - Is leader flag:', iframe?.contentWindow?.BEEMI_IS_LEADER);
            
            alert(`ğŸ‘¤ ${clientName} Client Info:\n\n` +
                  `Client Name: ${clientName}\n` +
                  `SDK Ready: ${!!iframe?.contentWindow?.beemi}\n` +
                  `Relay Active: ${!!iframe?.contentWindow?.multiClientEventCallbacks}\n` +
                  `Is Leader: ${iframe?.contentWindow?.BEEMI_IS_LEADER || false}`);
        }

        // Debug SDK status
        function debugSDKStatus() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                const sdk = iframe.contentWindow.beemi;
                
                console.log(`âš™ï¸ [${clientName}] SDK Debug Status:`);
                console.log('  - SDK version:', sdk.version || 'N/A');
                console.log('  - Core ready:', !!sdk.core);
                console.log('  - Multiplayer ready:', !!sdk.multiplayer);
                console.log('  - Streams ready:', !!sdk.streams);
                console.log('  - User ready:', !!sdk.user);
                console.log('  - SDK isReady():', sdk.isReady ? sdk.isReady() : 'N/A');
                
                alert(`âš™ï¸ ${clientName} SDK Status:\n\n` +
                      `Version: ${sdk.version || 'N/A'}\n` +
                      `Core: ${!!sdk.core}\n` +
                      `Multiplayer: ${!!sdk.multiplayer}\n` +
                      `Streams: ${!!sdk.streams}\n` +
                      `User: ${!!sdk.user}\n` +
                      `Ready: ${sdk.isReady ? sdk.isReady() : 'N/A'}`);
            } else {
                alert('âŒ SDK not ready or not accessible');
            }
        }

        // Test multi-client relay
        function testMultiClientRelay() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            if (iframe && iframe.contentWindow) {
                console.log(`ğŸŒ‰ [${clientName}] Testing multi-client relay...`);
                
                // Test sending a message to parent
                try {
                    iframe.contentWindow.postMessage({
                        type: 'multi-client-relay',
                        clientId: clientName,
                        data: {
                            type: 'test-message',
                            message: 'Hello from ' + clientName,
                            timestamp: Date.now()
                        }
                    }, '*');
                    
                    console.log(`âœ… [${clientName}] Test message sent to multi-client bridge`);
                    alert(`ğŸŒ‰ ${clientName} Relay Test:\n\nTest message sent to bridge!\nCheck console for details.`);
                } catch (error) {
                    console.error(`âŒ [${clientName}] Relay test failed:`, error);
                    alert(`âŒ ${clientName} Relay Test Failed:\n\n${error.message}`);
                }
            } else {
                alert('âŒ Iframe not ready');
            }
        }

        // Debug game state
        function debugGameState() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            if (iframe && iframe.contentWindow && iframe.contentWindow.game) {
                const game = iframe.contentWindow.game;
                
                console.log(`ğŸ¯ [${clientName}] Game Debug State:`);
                console.log('  - Game phase:', game.gamePhase);
                console.log('  - Player ID:', game.playerId);
                console.log('  - Is leader:', game.isLeader);
                console.log('  - Player count:', game.gamePlayerCount);
                console.log('  - Player names:', Array.from(game.playerNames.entries()));
                
                alert(`ğŸ¯ ${clientName} Game State:\n\n` +
                      `Phase: ${game.gamePhase}\n` +
                      `Player ID: ${game.playerId}\n` +
                      `Is Leader: ${game.isLeader}\n` +
                      `Player Count: ${game.gamePlayerCount}`);
            } else {
                alert('âŒ Game object not accessible');
            }
        }

        // Clear game console
        function clearGameConsole() {
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            console.clear();
            console.log(`ğŸ—‘ï¸ [${clientName}] Console cleared`);
        }

        // Test room hosting
        function testHostRoom() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                console.log(`ğŸ  [${clientName}] Testing room host...`);
                
                try {
                    const result = iframe.contentWindow.beemi.multiplayer.room.host('spy');
                    console.log(`âœ… [${clientName}] Host result:`, result);
                    
                    // Check room state after hosting
                    setTimeout(() => {
                        const roomState = iframe.contentWindow.beemi.multiplayer.room.getState();
                        console.log(`ğŸ  [${clientName}] Room state after host:`, roomState);
                        alert(`ğŸ  ${clientName} Host Test:\n\nRoom hosted!\nState: ${JSON.stringify(roomState)}`);
                    }, 500);
                } catch (error) {
                    console.error(`âŒ [${clientName}] Host test failed:`, error);
                    alert(`âŒ ${clientName} Host Test Failed:\n\n${error.message}`);
                }
            } else {
                alert('âŒ SDK not ready');
            }
        }

        // Test room joining
        function testJoinRoom() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            if (iframe && iframe.contentWindow && iframe.contentWindow.beemi) {
                console.log(`ğŸšª [${clientName}] Testing room join...`);
                
                try {
                    const result = iframe.contentWindow.beemi.multiplayer.room.join('MULTI');
                    console.log(`âœ… [${clientName}] Join result:`, result);
                    
                    // Check room state after joining
                    setTimeout(() => {
                        const roomState = iframe.contentWindow.beemi.multiplayer.room.getState();
                        console.log(`ğŸ  [${clientName}] Room state after join:`, roomState);
                        alert(`ğŸšª ${clientName} Join Test:\n\nRoom joined!\nState: ${JSON.stringify(roomState)}`);
                    }, 500);
                } catch (error) {
                    console.error(`âŒ [${clientName}] Join test failed:`, error);
                    alert(`âŒ ${clientName} Join Test Failed:\n\n${error.message}`);
                }
            } else {
                alert('âŒ SDK not ready');
            }
        }

        // Check injection status
        function checkInjectionStatus() {
            const iframe = document.querySelector('.webview-iframe');
            const clientName = window.BEEMI_CLIENT_NAME || 'Unknown Client';
            
            console.log(`ğŸ” [${clientName}] Checking injection status...`);
            
            if (!iframe) {
                alert('âŒ No iframe found');
                return;
            }
            
            if (!iframe.contentWindow) {
                alert('âŒ Iframe contentWindow not accessible');
                return;
            }
            
            const cw = iframe.contentWindow;
            const status = {
                multiClientRoomState: !!cw.multiClientRoomState,
                roomStateValue: cw.multiClientRoomState,
                beemiExists: !!cw.beemi,
                multiplayerExists: !!cw.beemi?.multiplayer,
                roomExists: !!cw.beemi?.multiplayer?.room,
                getStateExists: !!cw.beemi?.multiplayer?.room?.getState,
                getStateType: typeof cw.beemi?.multiplayer?.room?.getState
            };
            
            console.log(`ğŸ” [${clientName}] Injection Status:`, status);
            
            // Test getState directly
            if (cw.beemi?.multiplayer?.room?.getState) {
                try {
                    const currentState = cw.beemi.multiplayer.room.getState();
                    console.log(`ğŸ” [${clientName}] Current getState result:`, currentState);
                    status.currentGetStateResult = currentState;
                } catch (e) {
                    console.error(`ğŸ” [${clientName}] getState error:`, e);
                    status.getStateError = e.message;
                }
            }
            
            alert(`ğŸ” ${clientName} Injection Status:\n\n` +
                  `Room State Variable: ${status.multiClientRoomState}\n` +
                  `Beemi SDK: ${status.beemiExists}\n` +
                  `Multiplayer: ${status.multiplayerExists}\n` +
                  `Room: ${status.roomExists}\n` +
                  `getState: ${status.getStateExists} (${status.getStateType})\n` +
                  `Current State: ${JSON.stringify(status.currentGetStateResult)}\n\n` +
                  `Check console for full details`);
        }

        // Initialize iframe parameters when DOM is ready
        initializeIframeWithParams();
    </script>

    <script src="beemi-bridge-emulator.js"></script>
    
    <!-- Page Header (hidden when embedded) -->
    <header class="page-header">
        <h1><span class="icon-phone"><svg viewBox="0 0 210 210"><path d="M 67.194348 10.311515 C 59.070794 10.311515 52.530644 16.851149 52.530644 24.974703 L 52.530644 185.02488 C 52.530644 193.14844 59.070794 199.68859 67.194348 199.68859 L 142.80575 199.68859 C 150.92931 199.68859 157.46894 193.14844 157.46894 185.02488 L 157.46894 24.974703 C 157.46894 16.851149 150.92931 10.311515 142.80575 10.311515 L 67.194348 10.311515 z M 88.526896 20.271631 L 121.47269 20.271631 C 124.10908 20.271631 126.23157 22.394122 126.23157 25.030514 C 126.23157 27.666905 124.10908 29.789396 121.47269 29.789396 L 88.526896 29.789396 C 85.890505 29.789396 83.76853 27.666905 83.76853 25.030514 C 83.76853 22.394122 85.890505 20.271631 88.526896 20.271631 z"/></svg></span>Client Emulator</h1>
    </header>
    
    <script>
        // Detect if we're embedded in an iframe and apply transparent background
        if (window.self !== window.top) {
            document.body.classList.add('embedded');
            
            // Auto-collapse control panel when embedded (without animation)
            const controlPanelFrame = document.querySelector('.control-panel-frame');
            const phoneSection = document.querySelector('.phone-section');
            const toggleButton = document.querySelector('.collapse-toggle');
            
            if (controlPanelFrame && phoneSection && toggleButton) {
                // Temporarily disable transitions
                controlPanelFrame.style.transition = 'none';
                phoneSection.style.transition = 'none';
                
                // Apply collapsed state
                controlPanelFrame.classList.add('collapsed');
                phoneSection.classList.add('collapsed');
                toggleButton.innerHTML = 'â€º';
                toggleButton.title = 'Expand Panel';
                
                // Re-enable transitions after a brief delay
                setTimeout(() => {
                    controlPanelFrame.style.transition = '';
                    phoneSection.style.transition = '';
                }, 50);
                
                console.log('ğŸ›ï¸ Control panel auto-collapsed for embedded mode (no animation)');
            }
            
            // Check if we have a client name from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const clientName = urlParams.get('clientName');
            
            if (clientName) {
                console.log(`ğŸ”— ${clientName} emulator running in embedded mode (transparent background)`);
                // Store client name globally for other scripts to use
                window.BEEMI_CLIENT_NAME = clientName;
            } else {
                console.log('ğŸ”— Emulator running in embedded mode (transparent background)');
            }
        } else {
            console.log('ğŸ”— Emulator running in standalone mode (gradient background)');
        }
    </script>
</body>
</html> 